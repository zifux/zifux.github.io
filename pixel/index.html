<!DOCTYPE>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>像素绘</title>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/spectrum/1.8.0/spectrum.js"></script>
    <!--<script src="/static/js/spectrum.js"></script>-->
    <!--<link href="/static/js/spectrum.css" rel='stylesheet'/>-->
    <link href="https://cdn.bootcss.com/spectrum/1.8.0/spectrum.min.css" rel="stylesheet">
    <!--<link href="/public/static/js/bootstrap.min.css" rel='stylesheet'/>-->
    <!--<link href="/static/js/bootstrap.min.css" rel='stylesheet'/>-->
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0px;
        }

        canvas {
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            -ms-interpolation-mode: nearest-neighbor;
        }

        .sp-initial {
            float: none;
            border: none;
        }

        .sp-palette-container {
            float: none;
        }
        .full-spectrum {
            top: 228px;
            right: 0;
            width: 200px;
            border: solid 2px #D5D5D5;
            background-color: #D5D5D5;
            border-radius:0 0 0 6px ;
            /*box-shadow: 0px 0px 5px 0px rgba(0, 0, 0,0.5);*/
        }
        .sp-palette .sp-thumb-el{
            border-color: #fefefe;
        }
        * {
            -webkit-user-select: none; /* webkit (safari, chrome) browsers */
            -moz-user-select: none; /* mozilla browsers */
            -khtml-user-select: none; /* webkit (konqueror) browsers */
            -ms-user-select: none; /* IE10+ */
        }
        #picRect{
            border: solid 2px #D5D5D5;
            border-top: none;
        }
        #info{
            position: fixed; left:15px; right:15px;bottom:0;overflow: auto;


        }
        #infoBottom{
            background-color:rgba(0, 0, 0, 0.47);
            border-top: solid 2px rgb(141, 146, 166);
            height: auto;
            color: #fefefe;

        }
        #nav{
            float: right;
            background-color:rgba(0, 0, 0, 0.47);
            border-top: solid 2px rgb(141, 146, 166);
            height: auto;
            color: #fefefe;
            width: 100px;

        }
        .clickNav{

        }

    </style>
</head>
<body>
<div class="container-fluid" >
    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12" style="padding: 0px">
            <canvas id="zoom" width="1270" height="600" style="position: static;z-index: 0;margin: 0;padding: 0"></canvas>
        </div>
    </div>
    <div class="row" id="info">
        <div class="col-md-12 col-sm-12 col-xs-12" id="nav">
            <div class="row">
                <button onclick="move(0,-5)" id="up" class="col-md-12 col-sm-12 col-xs-12 btn btn-primary clickNav">
                    <span class="glyphicon glyphicon-menu-up"></span>
                </button>
            </div>
            <div class="row">
                <button onclick="move(-5,0)" id="left" class="col-md-6 col-sm-6 col-xs-6  btn btn-primary clickNav">
                    <span class="glyphicon glyphicon-menu-left"></span>
                </button>
                <button onclick="move(5,0)" id="right" class="col-md-6 col-sm-6 col-xs-6 btn btn-primary clickNav">
                    <span class="glyphicon glyphicon-menu-right"></span>
                </button>
            </div>

            <div class="row">
                <button onclick="move(0,5)" id="down" class="col-md-12 col-sm-12 col-xs-12 btn btn-primary clickNav">
                    <span class="glyphicon glyphicon-menu-down"></span>
                </button>
            </div>
        </div>
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="row" id="infoBottom">
                <div class="col-md-1 col-sm-1 col-xs-1">
                    <img src="files/test.png" height="98">
                </div>
                <div class="col-md-4 col-sm-3 col-xs-2">
                    <h2>像素绘 ver.04</h2>
                </div>
                <div class="col-md-2 col-sm-3 col-xs-3">
                    <div style="margin-top: 20px">
                        放大倍率:<strong id="scaleN">16.0</strong><br>

                        <input type="button" class="btn btn-primary" value="x04" onclick="changeScale(4)">



                        <input type="button" class="btn btn-primary"  value="x08" onclick="changeScale(8)">


                        <input type="button" class="btn btn-primary"  value="x16" onclick="changeScale(16)">


                        <input type="button" class="btn btn-primary"  value="x32" onclick="changeScale(32)">
                    </div>
                </div>
                <div class="col-md-3  col-sm-3 col-xs-3" style="margin-top: 5px">
                    说明<br/>
                    鼠标拖动来移动画布<br/>
                    点击或拖动右上角红框快速移动<br/>
                    单击画一个像素,测试阶段每秒可画一个像素<br/>
                </div>
                <div class="col-md-2 col-sm-2 col-xs-3">
                    <a id="downloadPic" class="btn btn-warning" href="#" download="pixelPic" style="float: right; margin-top: 28px; line-height: 40px;padding-top: 0;padding-bottom: 0" >
                        下载整图
                    </a>
                </div>
            </div>
        </div>

    </div>

</div>
<div style="position: absolute;right:0;top: 0;">
    <input type='text' id="full" value="#000000"/>
    <canvas id="picRect" style=" position: absolute;right: 0px;top: 0px;width: 200px;height: 200px;z-index:99"></canvas>
    <canvas id="pic" style="position: absolute;right: 0px;top: 0px;width: 200px;height: 200px"></canvas>
    <canvas id="download" style="display: none"></canvas>
    <canvas id="grid" style="display: none"></canvas>
    <div style="position: absolute;right: 0px;top: 198px;width: 200px;height: 30px;background: #D5D5D5;">
        <div id="color" style="width: auto; margin:2px;height: 22px; border:solid 1px #FFFFFF;border-radius:4px; background-color: #000000"></div>
    </div>
    <div id=" " style="padding: 2px; position: absolute;right: 0px;top: 498px;width: auto;height: auto;background: #D5D5D5; line-height: 30px;align-content: center">
        <label style="cursor: hand;margin: 0">
            <input type="checkbox" id="gridShow" style="margin: 0; vertical-align:middle;" onclick="refresh()" checked> 显示像素网格
        </label>

    </div>
</div>
</body>
<script>

    var scaleX = 300;
    var scaleY = 300;
    var scale = 16;
    var showScale = scaleX / 200;
    var zoomX = 0;
    var zoomY = 0;
    var zoomW = $(window).width(), zoomH = $(window).height();
    var offsetX=0;
    var offsetY=0;

    var canvas = document.getElementById('pic');
    var ctx = canvas.getContext('2d');
    canvas.width = scaleX;
    canvas.height = scaleY;
    ctx.imageSmoothingEnabled = false;
    ctx.mozImageSmoothingEnabled = false;
    ctx.webkitImageSmoothingEnabled = false;
    ctx.msImageSmoothingEnabled = false;

    var picRect = document.getElementById('picRect');
    var picRectCtx = picRect.getContext('2d');
    picRect.width = 200;
    picRect.height = 200;
    picRectCtx.imageSmoothingEnabled = false;
    picRectCtx.mozImageSmoothingEnabled = false;
    picRectCtx.webkitImageSmoothingEnabled = false;
    picRectCtx.msImageSmoothingEnabled = false;

    var color = document.getElementById('color');

    var zoom = document.getElementById('zoom');
    var zoomctx = zoom.getContext('2d');
    zoom.width = zoomW;
    zoom.height = zoomH;
    zoomctx.imageSmoothingEnabled = false;
    zoomctx.mozImageSmoothingEnabled = false;
    zoomctx.webkitImageSmoothingEnabled = false;
    zoomctx.msImageSmoothingEnabled = false;

    var grid = document.getElementById('grid');
    var gridctx = grid.getContext('2d');

    var down = document.getElementById('download');
    var downCtx = down.getContext('2d');
    var idata;
    var gridShow=document.getElementById("gridShow");
    ctx.fillStyle = "#fcfcfc";
    ctx.fillRect(0, 0, scaleX, scaleY);
    zoomctx.fillStyle="#393d5c";
    zoomctx.font = "48px serif";
    zoomctx.fillText('正在加载...',80,80);
    $.get('https://60.205.207.218:81/Index/index/getPic', function (dataStr) {
        var data = parsePic(dataStr);
        for (var index in data) {
            var pixelData = ctx.createImageData(1, 1);
            var d = data[index].split(',');
            var co = toRGB(d[2]);
            co.push(256);
            pixelData.data[0] = co[0];
            pixelData.data[1] = co[1];
            pixelData.data[2] = co[2];
            pixelData.data[3] = co[3];
            ctx.putImageData(pixelData, d[0], d[1]);
        }
        refresh(zoomX, zoomY, zoomW, zoomH);
    });
    function parsePic(str) {
        return str.split(':');

    }
    function getX(event) {
        return parseInt((event.layerX + zoomX*scale ) / scale);
    }
    function getY(event) {
        return parseInt((event.layerY+ zoomY*scale) / scale);
    }
    function draw(event) {
        //inPink();
        switch(event.button){
            case 0://left
                drLeft();
                break;
            case 1://middle
                drMid();
                break;
            case 2://right
                drRight();
                break;
            default:

        }
        function drLeft() {
            var color = getColorStr().substring(1);
            var con = {x: getX(event), y: getY(event), color: toRGB(color)};
            $.post('https://60.205.207.218:81/Index/index/drawPixel', {x: con.x, y: con.y, color: color}, function (redata) {
                var data = JSON.parse(redata);
                if (data['err'] === 0) {
                    var pixelData = ctx.createImageData(1, 1);
                    pixelData.data[0] = con.color[0];
                    pixelData.data[1] = con.color[1];
                    pixelData.data[2] = con.color[2];
                    pixelData.data[3] = 255;
                    ctx.putImageData(pixelData, con.x, con.y);
                    refresh(con.x, con.y, 1, 1);
                } else {
                    console.log(data);
                }

            });
        }
        function drMid() {

        }
        function drRight() {
            var x = getX(event);
            var y = getY(event);
            var pixel = ctx.getImageData(x, y, 1, 1);
            var data = pixel.data;
            var rgba = 'rgba(' + data[0] + ',' + data[1] +
                ',' + data[2] + ',' + data[3] + ')';
            color.style.background = rgba;
            $("#full").spectrum("set", rgba);
            //color.textContent = rgba;
        }

    }
    $('canvas').mousedown(function(e){if(e.button===1)return false}).contextmenu(function (e) {
        return false;
    });
    function downloadPic() {
        this.href=canvas.toDataURL('image/png');
    }
    function refresh(x, y, w, h) {
        zoomctx.drawImage(canvas,
            x,
            y,
            w, h,
            x * scale, y * scale,
            w * scale, h * scale);
    }

    function initGrid(){
        grid.width = scaleX*scale;
        grid.height = scaleY*scale;
        gridctx.imageSmoothingEnabled = false;
        gridctx.mozImageSmoothingEnabled = false;
        gridctx.webkitImageSmoothingEnabled = false;
        gridctx.msImageSmoothingEnabled = false;
        let m,n;
        gridctx.clearRect(0,0,zoomW,zoomH);
        gridctx.strokeStyle='rgba(229,229,229,0.6)';
        gridctx.strokeWidth=1;
        gridctx.beginPath();
        for( m=1;m<scaleY*scale;m++){
            gridctx.moveTo(0,m*scale);
            gridctx.lineTo(scaleX*scale,m*scale);
        }
        for( n=1;n<scaleX*scale;n++){
            gridctx.moveTo(n*scale,0);
            gridctx.lineTo(n*scale,scaleY*scale);
        }
        gridctx.stroke();
    }
    initGrid();
    function drawGrid() {
        if(!gridShow.checked)return;
        zoomctx.drawImage(grid,
            zoomX*16,
            zoomY*16,
            zoomW/scale*16, zoomH/scale*16,
            0, 0,
            zoomW, zoomH);
    }
    function refresh() {
        zoomctx.fillStyle = '#e5e5e5';
        zoomctx.fillRect(0, 0, zoomW, zoomH);
        zoomctx.drawImage(canvas,
            zoomX,
            zoomY,
            zoomW / scale, zoomH / scale,
            0, 0,
            zoomW, zoomH);
        drawGrid();
    }
    function changeScale(sc){
        if(sc<1)sc=1;
        if(sc>32)sc=32;
        scaleN.innerHTML=Number(sc).toFixed(1);
        //initGrid();
        zoomX+=(zoomW / scale-zoomW/sc)/2;
        zoomY+= (zoomH / scale-zoomH/sc)/2;
        scale=sc;
        refresh();
        refreshRect();
        //gridShow.checked=false;
    }
    rectX = 0, rectY = 0;
    away=false;
    function willDraw(event) {

        var x = getX(event);
        var y = getY(event);
        offsetX=event.layerX/scale-x;
        offsetY=event.layerY/scale-y;
        if(picMouseLeft===true){
            let zx=-event.layerX/scale + picMouseDownPos.x;
            let zy=-event.layerY/scale + picMouseDownPos.y;
            if(!away){
                if(Math.abs(zx)<zoomH/1800)
                    zx=0;
                if(Math.abs(zy)<zoomH/1800)
                    zy=0;
                if(zx!==0||zy!==0){
                    picMouseMove=true;
                }
            }
        }else if(picMouseDown===true){
            picMouseMove=true;
            let zx=-event.layerX/scale + picMouseDownPos.x;
            let zy=-event.layerY/scale + picMouseDownPos.y;
            if(!away){
                if(Math.abs(zx)<zoomH/2000)
                    zx=0;
                if(Math.abs(zy)<zoomH/2000)
                    zy=0;
                if(zx!==0||zy!==0){
                    away=true;
                }
            }
            zoomX = zx + picMouseDownPos.zoomX;
            zoomY = zy + picMouseDownPos.zoomY;
            refresh();
            refreshRect();
            picMouseDownPos.skip++;
            let time=new Date().getTime();
            if(picMouseDownPos.skip>5||time-picMouseDownPos.time>5){
                let a=picMouseDownPos.oldx - event.layerX;
                let b=picMouseDownPos.oldy - event.layerY;
                if(Math.abs(a)<zoomW/500){
                    a=0;
                }
                if(Math.abs(b)<zoomH/500){
                    b=0;
                }
                picMouseDownPos.vx= a/(time-picMouseDownPos.time);
                picMouseDownPos.vy= b/(time-picMouseDownPos.time);
                picMouseDownPos.time=time;
                picMouseDownPos.oldx=event.layerX;
                picMouseDownPos.oldy = event.layerY;
                picMouseDownPos.skip=0;
            }
        }else{
            if (rectX !== x || rectY !== y) {
                picMouseMove=true;
                zoomctx.fillStyle = '#e5e5e5';
                zoomctx.fillRect((x - 50) * scale, (y - 50) * scale, 100 * scale, 100 * scale);
                refresh(x - 50, y - 50, 100, 100);
                zoomctx.beginPath();
                zoomctx.strokeStyle = getColorStr();
                zoomctx.lineWidth = 2;
                zoomctx.rect((x) * scale-zoomX*scale, (y) * scale-zoomY*scale, 1 * scale, 1 * scale);
                zoomctx.stroke();
            }
        }
    }
    function refreshRect() {
        picRectCtx.clearRect(0, 0, 200, 200);
        picRectCtx.beginPath();
        picRectCtx.strokeStyle = "#e5434f";
        picRectCtx.lineWidth = 2;
        var w = zoomW / scale / showScale;
        var h = zoomH / scale / showScale;
        picRectCtx.rect(zoomX / showScale, zoomY / showScale, w, h);
        picRectCtx.stroke();
    }
    function move(x,y) {
        zoomX += x;
        zoomY+=y;
        refresh();
    }
    function toRGB(str) {
        var c = str.match(/[0-9a-fA-F]{2}/g, 3);
        var co = [];
        for (var rgb in c) {
            co.push(parseInt(c[rgb], 16))
        }
        return co;
    }
    function toStr(rgb) {
        var str = '';
        for (var s in rgb) {
            var tmp = rgb[s].toString(16);
            str += tmp.length < 2 ? '0' + tmp : tmp;
        }
        return str;
    }
    function getColorStr() {
        return $('#full').val();
    }
    function pick(event) {

    }
    function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
            x: evt.clientX - rect.left,
            y: evt.clientY - rect.top
        };
    }
    var reckMouseDown = false;
    var picMouseDown = false;
    var picMouseLeft=false;
    var picMouseMove=false;
    var picMouseDownPos = {x: 0, y: 0, zoomX: zoomX, zoomY: zoomY,oldx:0,oldy:0,vx:0,vy:0,time:0,timer:-1,skip:0};
    function rectMove(event) {
        if (!reckMouseDown)return;
        var pos = getMousePos(picRect, event);
        picRectCtx.clearRect(0, 0, 200, 200);
        picRectCtx.beginPath();
        picRectCtx.strokeStyle = "#e5434f";
        picRectCtx.lineWidth = 2;
        var w = zoomW / scale / showScale;
        var h = zoomH / scale / showScale;
        picRectCtx.rect((pos.x) - w / 2, (pos.y) - h / 2, w, h);
        picRectCtx.stroke();
        zoomX = parseInt(((pos.x) - w / 2) * showScale);
        zoomY = parseInt(((pos.y) - h / 2) * showScale);
        refresh()
    }
    $('#downloadPic').on('click',function (event) {
        down.width = scaleX*scale;
        down.height = scaleY*scale;
        downCtx.imageSmoothingEnabled = false;
        downCtx.mozImageSmoothingEnabled = false;
        downCtx.webkitImageSmoothingEnabled = false;
        downCtx.msImageSmoothingEnabled = false;
        downCtx.drawImage(canvas,
            0,
            0,
            scaleX, scaleY,
            0, 0,
            scaleX * scale, scaleY * scale);
        $('#downloadPic').attr('href',down.toDataURL('image/png'));
    });
    picRect.addEventListener('mousedown', function (event) {
        reckMouseDown = true;
        rectMove(event);
    });
    picRect.addEventListener('mouseup', function (event) {
        reckMouseDown = false;
    });
    $(picRect).on('mouseenter', function (event) {
        reckMouseDown = false;
    });
    zoom.addEventListener('mousedown', function (event) {
        clearInterval(picMouseDownPos.timer);
        //picMouseDownPos = {x: 0, y: 0, zoomX: zoomX, zoomY: zoomY,oldx:0,oldy:0,vx:0,vy:0,time:0,timer:-1,skip:0};
        picMouseDown = event.button===2;

        picMouseLeft=event.button===0;


        picMouseMove =false;
        away=false;
        picMouseDownPos.skip=0;
        picMouseDownPos.x = event.layerX/scale;
        picMouseDownPos.y = event.layerY/scale;
        picMouseDownPos.oldx=event.layerX;
        picMouseDownPos.oldy=event.layerY;
        picMouseDownPos.vx=0;
        picMouseDownPos.vy=0;
        picMouseDownPos.zoomX = zoomX;
        picMouseDownPos.zoomY = zoomY;
        picMouseDownPos.time=new Date().getTime();
    },false);
    zoom.addEventListener('mouseup', function (event) {
        if(picMouseDown){
            picMouseDown = false;
            away=false;
            let x=getX(event) - zoomX;
            let y = getY(event) - zoomY;
            if(!picMouseMove||(picMouseDownPos.vx===0&&picMouseDownPos.vy===0)){
            }else{
                if(Math.abs( picMouseDownPos.vx)+Math.abs(picMouseDownPos.vy)<0.001)return;
                picMouseDownPos.vx=picMouseDownPos.vx>3?3:picMouseDownPos.vx;
                picMouseDownPos.vy=picMouseDownPos.vy>3?3:picMouseDownPos.vy;
                picMouseDownPos.vx=picMouseDownPos.vx<-3?-3:picMouseDownPos.vx;
                picMouseDownPos.vy=picMouseDownPos.vy<-3?-3:picMouseDownPos.vy;
                picMouseDownPos.timer=setInterval(function () {
                    zoomX+=picMouseDownPos.vx*20/scale;
                    zoomY+=picMouseDownPos.vy*20/scale;
                    picMouseDownPos.vx/=1.2;
                    picMouseDownPos.vy/=1.2;
                    refresh();
                    if(Math.abs( picMouseDownPos.vx)+Math.abs(picMouseDownPos.vy)<0.001){
                        clearInterval(picMouseDownPos.timer);
                    }
                },20);
            }
        }else if(picMouseLeft){
            picMouseLeft=false;
            if(!picMouseMove/*||(picMouseDownPos.vx===0&&picMouseDownPos.vy===0)*/){
                draw(event);
            }
        }

    },false);
    $(zoom).on('mouseenter', function (event) {
        picMouseDown = false;
    }).on('mousewheel DOMMouseScroll',function (event, delta) {
        event.preventDefault();
        var value = event.originalEvent.wheelDelta || -event.originalEvent.detail;
        //e.originalEvent.wheelDelta => 120(up) or -120(down) 谷歌IE内核
        //e.originalEvent.detail => -3(up) or 3(down) 火狐内核
        var delta = Math.max(-0.1, Math.min(0.1, value));
        changeScale(scale+scale*delta);
    });

    picRect.addEventListener('mousemove', rectMove);
    //canvas.addEventListener('mousemove', pick);
    zoom.addEventListener('mousemove', willDraw,false);
    $("#full").spectrum({
        flat: true,
        color: "#000000",
        cancelText: '取消',
        chooseText: '选择',
        showButtons: true,
        showInput: true,
        allowEmpty: false,
        showAlpha: false,
        className: "full-spectrum",
        showInitial: true,
        showPalette: true,
        showPaletteOnly: true,
        showSelectionPalette: true,
        maxSelectionSize: 10,
        preferredFormat: "hex",
        localStorageKey: "spectrum.pic",
        move: function (color) {
        },
        show: function () {

        },
        beforeShow: function () {

        },
        hide: function () {

        },
        change: function (col) {
            color.style.background = col;
        },
        palette: [
            ["rgb(0, 0, 0)", "rgb(67, 67, 67)", "rgb(102, 102, 102)",
                "rgb(204, 204, 204)", "rgb(217, 217, 217)", "rgb(255, 255, 255)"],
            ["rgb(152, 0, 0)", "rgb(255, 0, 0)", "rgb(255, 153, 0)", "rgb(255, 255, 0)", "rgb(0, 255, 0)",
                "rgb(0, 255, 255)", "rgb(74, 134, 232)", "rgb(0, 0, 255)", "rgb(153, 0, 255)", "rgb(255, 0, 255)"],
            ["rgb(230, 184, 175)", "rgb(244, 204, 204)", "rgb(252, 229, 205)", "rgb(255, 242, 204)", "rgb(217, 234, 211)",
                "rgb(208, 224, 227)", "rgb(201, 218, 248)", "rgb(207, 226, 243)", "rgb(217, 210, 233)", "rgb(234, 209, 220)",
                "rgb(221, 126, 107)", "rgb(234, 153, 153)", "rgb(249, 203, 156)", "rgb(255, 229, 153)", "rgb(182, 215, 168)",
                "rgb(162, 196, 201)", "rgb(164, 194, 244)", "rgb(159, 197, 232)", "rgb(180, 167, 214)", "rgb(213, 166, 189)",
                "rgb(204, 65, 37)", "rgb(224, 102, 102)", "rgb(246, 178, 107)", "rgb(255, 217, 102)", "rgb(147, 196, 125)",
                "rgb(118, 165, 175)", "rgb(109, 158, 235)", "rgb(111, 168, 220)", "rgb(142, 124, 195)", "rgb(194, 123, 160)",
                "rgb(166, 28, 0)", "rgb(204, 0, 0)", "rgb(230, 145, 56)", "rgb(241, 194, 50)", "rgb(106, 168, 79)",
                "rgb(69, 129, 142)", "rgb(60, 120, 216)", "rgb(61, 133, 198)", "rgb(103, 78, 167)", "rgb(166, 77, 121)",
                "rgb(91, 15, 0)", "rgb(102, 0, 0)", "rgb(120, 63, 4)", "rgb(127, 96, 0)", "rgb(39, 78, 19)",
                "rgb(12, 52, 61)", "rgb(28, 69, 135)", "rgb(7, 55, 99)", "rgb(32, 18, 77)", "rgb(76, 17, 48)"]
        ]
    });

</script>
</html>